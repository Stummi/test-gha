name: Update Readme Versions

on:
  repository_dispatch:
    types: [create_release]

jobs:
  update_release_draft:
    uses: Staffbase/gha-workflows/.github/workflows/template_release_drafter.yml@add-release-output

  update_readme:
    needs: [update_release_draft]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the source code
        uses: actions/checkout@v3
      - name: Find and Replace old versions
        uses: jacobtomlinson/gha-find-replace@v2
        with:
          find: "(v[0-9].[0-9].[0-9])"
          replace: ${{ github.ref_name }}
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v4
        with:
          add-paths: |
            README.md
      - name: Enable Pull Request Automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v2
        with:
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
      - name: Auto approve
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: juliangruber/approve-pull-request-action@v1
        with:
          number: ${{ steps.cpr.outputs.pull-request-number }}
      - name: Wait for Merge
        run: sleep 60s
        shell: bash

  create_release:
    needs: [update_readme]
    uses: Staffbase/gha-workflows/.github/workflows/template_release_drafter.yml@add-release-output
    with:
      publish: true
